<!DOCTYPE html>




<html
 dir="ltr"
 lang="en"
 >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content=#ffffff>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" type="image/png"
           href="/favicon.ico" 
    />
    <script defer src="https://unpkg.com/alpinejs@3.9.0/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-social@1/bin/bulma-social.min.css">
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Create your own private egg repository on amazon EC2 | Mosaico (Blog de Noe Nieto)</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Create your own private egg repository on amazon EC2" />
<meta name="author" content="Noe Nieto" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I want a private Python egg repository (basic authentication) and I want it on the cloud. Let’s see how it goes." />
<meta property="og:description" content="I want a private Python egg repository (basic authentication) and I want it on the cloud. Let’s see how it goes." />
<link rel="canonical" href="http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html" />
<meta property="og:url" content="http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html" />
<meta property="og:site_name" content="Mosaico (Blog de Noe Nieto)" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-03-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Create your own private egg repository on amazon EC2" />
<meta name="twitter:site" content="@misaelnieto_a" />
<meta name="twitter:creator" content="@Noe Nieto" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Noe Nieto"},"dateModified":"2011-03-30T00:00:00+00:00","datePublished":"2011-03-30T00:00:00+00:00","description":"I want a private Python egg repository (basic authentication) and I want it on the cloud. Let’s see how it goes.","headline":"Create your own private egg repository on amazon EC2","mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html"},"url":"http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html"}</script>
<!-- End Jekyll SEO tag -->

    
<script>if(!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!== 0){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"nnieto",utcoffset:"-7"}))};sessionStorage.setItem("_swa","1");</script>
<!-- head scripts --></head>

  <body>
    
<nav class="navbar is-primary" >
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="navbar-item">
                Mosaico (Blog de Noe Nieto)
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div class="navbar-menu" id="navMenu">
            <div class="navbar-start">
                
                
                    
                    <a href="/posts" class="navbar-item ">Posts archive</a>
                    
                
                    
                    <a href="/demos" class="navbar-item ">Demos, Tools & Toys</a>
                    
                
                    
                    <a href="https://www.noenieto.com/" class="navbar-item ">About me</a>
                    
                
                
            </div>

            <div class="navbar-end">
                
            </div>

        </div>
    </div>
</nav>

    
        <section class="hero  is-medium  is-bold is-primary" >
    <div class="hero-body ">
        <div class="container">
            <h1 class="title is-2">Create your own private egg repository on amazon EC2</h1>
            <p class="subtitle is-3"></p>
            
        </div>
    </div>
</section>
    
    


    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                
                <div class="column is-12">
                    
                    
                    
                    
                    <div class="content">

    <p>Published: Mar 30, 2011 by Noe Nieto</p>

    

    <p>I want a private Python egg repository (basic authentication) and I want it on
the cloud. Let’s see how it goes.</p>

<h2 id="intro">Intro</h2>

<p>We are starting to do more plone development. I started to learn and use
<a href="http://pypi.python.org/pypi/jarn.mkrelease">jarn.mkrelease</a> so I can properly
package my code and publish it on PyPI and re-use in different projects. But
I’ve yet to solve the problem of non-public code. So I found that
[<code class="language-plaintext highlighter-rouge">zc.buildout</code> might be able to open a pasword protected URL]
(http://stackoverflow.com/questions/4066571/using-custom-packages-on-my-python-project).</p>

<p>The idea is simple: setup a private package repository (a simple web server,
with a directory listing that’s pasword protected) and use zest.releaser to
upload eggs to the webserver using sftp, scp or something like that.</p>

<p>The web server can be anywere, so I created one on AWS.</p>

<h2 id="building-the-webserver">Building the webserver</h2>

<p>So I went to create a new account on Amazon EC2 in order to take advantage of
the Free Usage Tier that’s already available.</p>

<p>Once I finished the process, It was time to select the AMI. I had to read
through Ubuntu’s <a href="https://help.ubuntu.com/community/EC2StartersGuide">EC2 Starters Guide</a> 
to figure out which AMI to install.
Copying and Pasting Ubuntu’s Amazon ID into the “Community AMIs” search box
helped me to narrow the possible options. So, just for the fun of it, I
selected the latest natty server image for i386 (ami-0476846d).</p>

<p>All the rest of the steps are very straightforward: setup the server size
(t1.micro), create the server key and configure the firewall (allow SSH, HTTP
and HTTPS). After some seconds the instance is up and running.</p>

<p>This AMI image uses 8GB of EBS storage to “persist” it’s configuration. That
leaves me 2 GB for a stand-alone AMI image. I will use this image to store all
the eggs for my private repository.</p>

<p>So I went to “EBS Volumes” in the control panel, created the 2 GB volume (need
to be careful to select the same zone as the AMI EBS storage) and, when
finally available (blue dot), right click on it and select “Attach”, select
the AMI instance and the filesystem node and restart the instance.</p>

<p>Next, we need to make the partition and format the new available volume. I
used <code class="language-plaintext highlighter-rouge">cfdisk</code> to create the partition,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>cfdisk /dev/xvdb
<span class="nb">sudo </span>mkfs.ext3 /dev/xvdb1
</code></pre></div></div>

<p>Finally, modify <code class="language-plaintext highlighter-rouge">/etc/fstab</code> to mount <code class="language-plaintext highlighter-rouge">/dev/xvdb1</code> onto <code class="language-plaintext highlighter-rouge">/var/www</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /var/www
<span class="nb">sudo </span>nano /etc/fstab
<span class="nb">cat</span> /etc/fstab | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"#"</span>
proc             /proc   proc    nodev,noexec,nosuid    0       0
<span class="nv">LABEL</span><span class="o">=</span>uec-rootfs /       ext4    defaults               0       0
/dev/xvdb1      /var/www ext3   defaults,noatime,noexec 0       0
</code></pre></div></div>
<p><em>Note</em>: I used noatime option in order to avoid double writes to the EBS volume.</p>

<p>Now it is time to setup the webserver. I like nginx and
<a href="https://launchpad.net/~nginx/+archive/stable">there’s a PPA for it</a>.
So this one-liner installs it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>add-apt-repository ppa:nginx/stable <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nb">install </span>nginx
</code></pre></div></div>
<p>Now let’s do the nginx configuration. nginx runs as the <code class="language-plaintext highlighter-rouge">www-data</code> user</p>

<p>I want to have the logs on the separate EBS volume, So, let’s change
<code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code> and set the the path of the logfiles to:</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">access_log</span> <span class="n">/var/www/logs/access.log</span><span class="p">;</span>
<span class="k">error_log</span> <span class="n">/var/www/logs/error.log</span><span class="p">;</span>
</code></pre></div></div>

<p>Then, let’s setup the root directory and enable index listing by changing the
lines. For the root directory, I changed this line:</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">root</span> <span class="n">/var/www/webfiles</span><span class="p">;</span>
</code></pre></div></div>

<p>And to enable index listing I have to modify <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-
available/default</code> :</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
 <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="n">/index.html</span><span class="p">;</span>
 <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>Next, I mannually created the directories that will be used for files and logs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/www/webfiles
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/www/logs
</code></pre></div></div>

<p>By default these directories are owned by root, so we have to give permissions
to the ubuntu user in the <code class="language-plaintext highlighter-rouge">webfiles/</code> directory and permissions to <code class="language-plaintext highlighter-rouge">ww-data</code> on
<code class="language-plaintext highlighter-rouge">webfiles/</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chown</span> <span class="nt">-R</span> www-data /var/www/logs/
<span class="nb">sudo chown</span> <span class="nt">-R</span> ubuntu /var/www/webfiles
</code></pre></div></div>

<p>It’s also very wise to create a skeleton directory to hold out packages:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /var/www/webfiles/public
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/www/webfiles/private/customerA
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/www/webfiles/private/customerB
</code></pre></div></div>

<p>Finally restart the nginx server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service nginx restart
</code></pre></div></div>

<h3 id="assign-a-dns-name">Assign a DNS Name</h3>

<p>I had two options: 1) Add a CNAME record that points to the DNS name of the
EC2-Instance or 2) Allocate 1 Elastic IP, associate/route it to the EC-2
instance and use an A Record.</p>

<p>I choosed option 2 because I want to treat this EC2 Instance as somethig
disposable. The Amazon free tier covers the first 100 remaps for each elastic
IP. I’m pretty sure we will be way below this level. Password-protected
directories on nginx</p>

<p>The repository will have public and private areas. For example:
<code class="language-plaintext highlighter-rouge">http://dist.myserver.com/public</code> and <code class="language-plaintext highlighter-rouge">http://dist.myserver.com/private</code>. First,
let’s modify <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-available/default</code> and add the following:</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="s">^~</span> <span class="n">/private/</span> <span class="p">{</span>
 <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>
 <span class="kn">auth_basic</span>            <span class="s">"Restricted"</span><span class="p">;</span>
 <span class="kn">auth_basic_user_file</span>  <span class="n">/etc/nginx/htpasswd</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div></div>

<p>The first line inside the <code class="language-plaintext highlighter-rouge">location</code> directive turns on automatic indexing. The
second and third line enable the
<a href="http://wiki.nginx.org/HttpAuthBasicModule">basic authentication mechanism of nginx</a>.</p>

<p>To generate the <code class="language-plaintext highlighter-rouge">htpasswd</code> file we can use <a href="http://trac.edgewall.org/browser/trunk/contrib/htpasswd.py">this script</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python htpasswd.py <span class="nt">-c</span> <span class="nt">-b</span> htpasswordfile secretuser supersecretpassword
</code></pre></div></div>

<p>Once generated, copy the htpasswd file to <code class="language-plaintext highlighter-rouge">/etc/nginx</code> and fix the permissions …</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chown</span> <span class="nt">-R</span> www-data:root htpasswd
<span class="nb">sudo chmod </span>600 htpasswd
</code></pre></div></div>

<p>… create the public and private directorties….</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /var/www/webfiles/<span class="o">{</span>public,private<span class="o">}</span>
</code></pre></div></div>

<p>…. and restart the webserver.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service nginx restart
</code></pre></div></div>

<h2 id="releasing-eggs-to-the-repository">Releasing eggs to the repository</h2>

<p>First we need to automate the login procedure to the Amazon EC2 instance.
Normally, I would use this to login without password:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-i</span> /path/to/server_key.pem ubuntu@myserver.com
</code></pre></div></div>

<p>But some programs might not be able to give you options to include a ssh key.
The solution, then is to tell openssh that it should use that key whenever we
login to myserver.com.</p>

<p>First copy the <code class="language-plaintext highlighter-rouge">.pem</code> key to <code class="language-plaintext highlighter-rouge">~/.ssh</code> , then edit <code class="language-plaintext highlighter-rouge">~/.ssh/config</code> and add the
following lines:</p>

<div class="language-ssh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Host</span> dist.myserver.com
    <span class="k">IdentityFile</span> ~/.ssh/server_key.pem
</code></pre></div></div>

<p>Now we need to install <code class="language-plaintext highlighter-rouge">jarn.mkrelease</code>. I used buildout; I just added the
following lines and included mkrelease in the parts section on <code class="language-plaintext highlighter-rouge">[buildout]</code>.</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[buildout]</span>
<span class="py">parts</span> <span class="p">=</span>
    <span class="err">...</span>
    <span class="err">mkrelease</span>

<span class="nn">[mkrelease]</span>
    <span class="py">recipe</span> <span class="p">=</span> <span class="s">zc.recipe.egg</span>
    <span class="py">eggs</span> <span class="p">=</span> <span class="s">jarn.mkrelease</span>
</code></pre></div></div>

<p>That installs mkrelease in <code class="language-plaintext highlighter-rouge">bin/</code> directory of buildout. Now it’s time to
configure <code class="language-plaintext highlighter-rouge">jarn.mkrelease</code> to upload eggs to our new repository by adding the
following configuration to <code class="language-plaintext highlighter-rouge">~/.mkrelease</code>:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[aliases]</span>
<span class="py">plone</span> <span class="p">=</span>
 <span class="err">pypi</span>
 <span class="err">ploneorg</span>

<span class="py">myserver_public</span> <span class="p">=</span>
 <span class="err">user@dist.myserver.com:/var/www/webfiles/public</span>
<span class="py">clientA</span> <span class="p">=</span>
 <span class="err">user@dist.iservices.com:/var/www/webfiles/private/clientA</span>
</code></pre></div></div>

<p>**Note: Do not forget to create the directorties and set the appropiate
**permissions to <code class="language-plaintext highlighter-rouge">/var/www/webfiles</code>.</p>

<p>Let’s also configure <code class="language-plaintext highlighter-rouge">~/.pypirc</code> with the information about pypi and plone.org:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[distutils]</span>
<span class="py">index-servers</span> <span class="p">=</span>
 <span class="err">pypi</span>
 <span class="err">ploneorg</span>

<span class="nn">[pypi]</span>
<span class="py">username</span> <span class="p">=</span> <span class="s">mysuer</span>
<span class="py">password</span> <span class="p">=</span> <span class="s">password</span>

<span class="nn">[ploneorg]</span>
<span class="py">repository</span> <span class="p">=</span> <span class="s">http://plone.org/products</span>
<span class="py">username</span> <span class="p">=</span> <span class="s">myuser</span>
<span class="py">password</span> <span class="p">=</span> <span class="s">password</span>
</code></pre></div></div>

<p>Finally, in order to release eggs to the different repositories we will use
various commands. So let’s suppose we are inside a directory that contains the
code for one egg and it’s a git repository:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>my.product/
<span class="nb">ls
  </span>docs  my  my.product.egg-info README.rst  setup.cfg  setup.py
</code></pre></div></div>

<p>To release to pypi and plone.org:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/mkrelease <span class="nt">-T</span> <span class="nt">-d</span> pypi <span class="nb">.</span>
bin/mkrelease <span class="nt">-T</span> <span class="nt">-d</span> ploneorg <span class="nb">.</span>
</code></pre></div></div>

<p>To release to <code class="language-plaintext highlighter-rouge">myserver_public</code> :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/mkrelease <span class="nt">-T</span> <span class="nt">-d</span> myserver_public <span class="nb">.</span>
</code></pre></div></div>
<p>And finally, releasing to clientA :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/mkrelease <span class="nt">-T</span> <span class="nt">-d</span> clientA <span class="nb">.</span>
</code></pre></div></div>

<h2 id="using-the-private-and-public-repository">Using the private and public repository</h2>

<p>Once you’ve released your eggs to your public and private repositories, it’s
time to use them in your buildout. And turns out to be brain-dead easy.</p>

<p>Public repo:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[buildout]</span>
<span class="py">find-links</span> <span class="p">=</span>
    <span class="err">...</span>
    <span class="err">http://dist.myserver.com/public</span> 
</code></pre></div></div>
<p>And for the private repo:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[buildout]</span>
<span class="py">find-links</span> <span class="p">=</span>
    <span class="err">...</span>
    <span class="err">http://username:password@dist.myserver.com/private</span>
    <span class="err">http://username:passowrd@dist.myserver.com/private/clientA</span>
</code></pre></div></div>

<p>The End.</p>

</div>

<div class="tags">
    
</div>


<p><strong>Share</strong></p>
<div class="buttons ">
    <a class="button is-medium is-facebook"
       onclick="window.open('https://www.facebook.com/share.php?u=http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html');">
        <span class="icon"><i class="fab fa-facebook fa-lg"></i></span>
    </a>
    <a class="button is-medium is-twitter"
       onclick="window.open('https://twitter.com/intent/tweet?text=http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html');">
        <span class="icon"><i class="fab fa-twitter fa-lg"></i></span>
    </a>
    <a class="button is-medium is-linkedin"
       onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html&title=Create+your+own+private+egg+repository+on+amazon+EC2&summary=&source=');">
        <span class="icon"><i class="fab fa-linkedin fa-lg"></i></span>
    </a>
    <a class="button is-medium is-reddit"
       onclick="window.open('https://reddit.com/submit?url=http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html');">
        <span class="icon"><i class="fab fa-reddit fa-lg"></i></span>
    </a>
</div>



  

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html';
      this.page.identifier = 'http://blog.noenieto.com/2011/03/30/create-your-own-private-egg-repository-on-amazon-ec2.html';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://noenieto.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



                </div>
                
            </div>
        </div>
    </section>
    
        <footer class="footer">
    <div class="container">
        
        
        <div class="columns is-multiline">
            
        </div>
        

        <div class="content is-small has-text-centered">
            <p class="">Theme built by <a href="https://www.csrhymes.com">C.S. Rhymes</a></p>
        </div>
    </div>
</footer>

    
    <script src="/assets/js/app.js" type="text/javascript"></script><!-- footer scripts --></body>
</html>
